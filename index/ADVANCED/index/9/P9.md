# MOVE ADVANCED - Part 9 - APTOS SDK

<img src="https://raw.githubusercontent.com/net2devcrypto/misc/main/net2dev-sociallogo.png" width="200px;" />
<a href="https://github.com/net2devcrypto/MOVE-Smart-Contracts/tree/main/index/ADVANCED"><b>RETURN TO ADVANCED MENU</b></a>

<h4>Video LINK</h4>
<a href="" target="_blank"><img src="https://github.com/net2devcrypto/misc/blob/main/ytlogo2.png" width="120" height="30"></a>

## APTOS SDK HOW TO
1- Create new folder named "aptos_sdk" and open folder in VS Code.

2- Inside the folder, create file named "package.json", add the info below and save:
```json
{
  "dependencies": {
    "@aptos-labs/ts-sdk": "^1.22.2"
  },
  "devDependencies": {
    "@types/node": "^20.14.9",
    "ts-node": "^10.9.2",
    "tslib": "^2.6.3",
    "typescript": "^5.5.2"
  }
}
```
3- Inside the folder, create file named "tsconfig.json", add the info below and save:
```json
{
    "compilerOptions": {
      "allowSyntheticDefaultImports": true,
      "allowJs": true,
      "declaration": true,
      "declarationMap": true,
      "esModuleInterop": true,
      "experimentalDecorators": true,
      "module": "commonjs",
      "noImplicitAny": true,
      "outDir": "./dist",
      "sourceMap": true,
      "target": "es2020",
      "pretty": true,
      "strict": true,
      "strictNullChecks": true,
      "noEmit": true,
    },
    "include": ["./*.ts"],
    "paths": {
      "@aptos/*": "../.."
    }
  }
```
4- Navigate to folder in terminal and run "npm i":
```shell
cd aptos_sdk
npm i
```
5- In folder, Create file named "aptos_util.ts", add the info below, update with your private key and save:
```js
/* eslint-disable no-console */

import { Ed25519PrivateKey, 
    Aptos, AptosConfig, 
    Network, 
    NetworkToNetworkName } from "@aptos-labs/ts-sdk";
  
  const APTOS_NETWORK: Network = NetworkToNetworkName[Network.DEVNET];
  const config = new AptosConfig({ network: APTOS_NETWORK });
  const aptos = new Aptos(config);
  const OWNER_PRIVATE_KEY = "ENTER_PRIVATE_KEY";


  const getSigner = async () => {
    const privateKey = new Ed25519PrivateKey(OWNER_PRIVATE_KEY);
    const signer = await aptos.deriveAccountFromPrivateKey({ privateKey });
    return signer
  }

  export { aptos, getSigner };
```
6- In folder, Create file named "aptos_write.ts", add the info below, add your account and save:
```js
import { aptos, getSigner } from "./aptos_utils";

const ACCOUNT = "0xENTER_ACCOUNT_ID";
const MODULE_NAME = "price_feeds";

const writeModuleFunction = async (price: string, symbol:string) => {
    const signer = await getSigner();
    const txn = await aptos.transaction.build.simple({
      sender: signer.accountAddress,
      data: {
        function: `${ACCOUNT}::${MODULE_NAME}::update_feed`,
        typeArguments: [],
        functionArguments: [price, `string:${symbol}`],
      },
    });

    const committedTxn = await aptos.signAndSubmitTransaction({ 
        signer: signer, 
        transaction: txn 
    });
  
    await aptos.waitForTransaction({ transactionHash: committedTxn.hash });
    console.log(`Committed transaction: ${committedTxn.hash}\n`);
  }
  writeModuleFunction("63000", "BTC");
```
7- In folder, Create file named "aptos_view.ts", add the info below, add your account and save:
```js
import { aptos } from "./aptos_utils";
import { InputViewFunctionData } from "@aptos-labs/ts-sdk";

const ACCOUNT = "0xENTER_ACCOUNT_ID";
const MODULE_NAME = "price_feeds";

const viewModuleFunction = async (symbol: string) => {
    const payload: InputViewFunctionData = {
        function: `${ACCOUNT}::${MODULE_NAME}::get_token_price`,
        typeArguments: [],
        functionArguments: [`string:${symbol}`],
      };
      const output = (await aptos.view({ payload }));
      console.log(output[0]);
};

viewModuleFunction("BTC");
```

8- Deploy the updated price feeds module then test write and read to the module

- Update aptos_write.ts (end of file) and save
```js
writeModuleFunction("63000", "BTC");
```
- Execute write 
```shell
npx ts-node .\aptos_write.ts
```

- Update aptos_view.ts (end of file) and save
```js
viewModuleFunction("BTC");
```
- Execute view
```shell
npx ts-node .\aptos_view.ts
```
- You should've obtained something similar:
```shell
{ last_price: '65000', timestamp: '1728842660' }
```

## Updated Price Feeds Module
```ruby
module net2dev_addr::price_feeds{
    use std::vector;
    use std::string::{String, utf8};
    use std::timestamp;
    use std::signer;

    struct TokenFeed has store, drop, copy {
        last_price: u64,
        timestamp: u64
    }

    struct PriceFeeds has key, store, drop, copy {
        symbols: vector<String>,
        data: vector<TokenFeed>
    }

    const ENOT_OWNER: u64 = 101;

    fun init_module(owner: &signer){
        let symbols = vector::empty<String>();
        vector::push_back(&mut symbols, utf8(b"BTC"));
        let new_feed = TokenFeed {
            last_price: 0,
            timestamp: 0
        };
        let data_feed = PriceFeeds {
            symbols: symbols,
            data: (vector[new_feed])
        };
        move_to(owner, data_feed);
    }

    public entry fun update_feed(owner: &signer, last_price: u64, symbol: String)
    acquires PriceFeeds {
        let signer_addr = signer::address_of(owner);
        assert!(signer_addr == @net2dev_addr, ENOT_OWNER);
        let time = timestamp::now_seconds();
        let data_store = borrow_global_mut<PriceFeeds>(signer_addr);
        let new_feed = TokenFeed {
            last_price: last_price,
            timestamp: time
        };
        let (result, index) = vector::index_of(&mut data_store.symbols, &symbol);
        if (result == true){
            vector::remove(&mut data_store.data, index);
            vector::insert(&mut data_store.data, index, new_feed);
        }
        else {
            vector::push_back(&mut data_store.symbols, symbol);
            vector::push_back(&mut data_store.data, new_feed);
        }
    }

    #[view]
    public fun get_token_price(symbol: String): TokenFeed
    acquires PriceFeeds{
        let symbols = borrow_global<PriceFeeds>(@net2dev_addr).symbols;
        let (result, index) = vector::index_of(&symbols, &symbol);
        if (result == true){
            let data_feed = borrow_global<PriceFeeds>(@net2dev_addr).data;
            *vector::borrow(&data_feed, index)
        }
        else{
            TokenFeed {
                last_price: 0,
                timestamp: 0
            }
        }
    }

    #[test_only]
    use std::debug::print;


    #[test(owner = @net2dev_addr, init_addr = @0x1)]
    fun test_function(owner: &signer, init_addr: signer) acquires PriceFeeds {
        timestamp::set_time_has_started_for_testing(&init_addr);
        init_module(owner);
        update_feed(owner, 63400, utf8(b"BTC"));
        let result = get_token_price(utf8(b"BTC"));
        print(&result);
        update_feed(owner, 2421, utf8(b"ETH"));
        result = get_token_price(utf8(b"ETH"));
        print(&result);
        update_feed(owner, 62411, utf8(b"BTC"));
        result = get_token_price(utf8(b"BTC"));
        print(&result);
    }
}
```

